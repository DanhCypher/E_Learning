<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Questions</title>
    <link rel="stylesheet" href="style.css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <h1>View Questions</h1>
    </header>
    <main>
        <section id="view-questions">
            <h2>Select Exam</h2>
            <form id="view-questions-form">
                <select id="exam-select-view"></select>
                <button type="submit">View Questions</button>
            </form>
        </section>
        <section id="question-list">
            <h2>Questions</h2>
            <ul id="questions"></ul>
        </section>
    </main>
    <script>
        const API_BASE = 'http://localhost:3000';
        const examId = new URLSearchParams(window.location.search).get('examId'); // Lấy examId từ URL

        // Function to delete a question
        async function deleteQuestion(questionId) {
            if (!examId) {
                alert('Exam ID is missing!');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/questions/${examId}/questions/${questionId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('Question deleted successfully!');
                    fetchQuestions(); // Cập nhật danh sách câu hỏi sau khi xóa
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete question: ${errorData.message}`);
                }
            } catch (error) {
                alert('An error occurred while deleting the question.');
                console.error(error);
            }
        }

        // Function to update a question
        async function updateQuestion(questionId, newQuestion, newOptions, newCorrectAnswer) {
            if (!examId) {
                alert('Exam ID is missing!');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/questions/${examId}/questions/${questionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: newQuestion,
                        options: newOptions,
                        correctAnswer: newCorrectAnswer,
                    }),
                });

                if (response.ok) {
                    alert('Question updated successfully!');
                    fetchQuestions(); // Cập nhật danh sách câu hỏi sau khi sửa
                } else {
                    const errorData = await response.json();
                    alert(`Failed to update question: ${errorData.message}`);
                }
            } catch (error) {
                alert('An error occurred while updating the question.');
                console.error(error);
            }
        }

        async function fetchQuestions() {
            if (!examId) {
                alert('Invalid exam ID. Please select an exam.');
                return;
            }

            const response = await fetch(`${API_BASE}/questions/${examId}/questions`);
            const data = await response.json();

            const questionsList = document.getElementById('questions');
            questionsList.innerHTML = '';

            if (data.questions && data.questions.length > 0) {
                data.questions.forEach((q, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>Q${index + 1}: ${q.question}</strong>
                        <ul>
                            ${q.options.map(option => `<li>${option}</li>`).join('')}
                        </ul>
                        <p><strong>Correct Answer:</strong> ${q.correctAnswer}</p>
                    `;

                    // Container cho các biểu tượng
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('actions');

                    // Biểu tượng sửa câu hỏi
                    const editIcon = document.createElement('i');
                    editIcon.classList.add('fas', 'fa-edit'); // Icon sửa
                    editIcon.title = 'Edit Question'; // Tooltip khi hover
                    editIcon.style.cursor = 'pointer';
                    editIcon.style.marginRight = '10px';
                    editIcon.addEventListener('click', () => {
                        const newQuestion = prompt('Enter new question:', q.question);
                        const newOptions = prompt('Enter new options (comma-separated):', q.options.join(','));
                        const newCorrectAnswer = prompt('Enter new correct answer:', q.correctAnswer);

                        if (newQuestion && newOptions && newCorrectAnswer) {
                            updateQuestion(q._id, newQuestion, newOptions.split(',').map(opt => opt.trim()), newCorrectAnswer);
                        }
                    });

                    // Biểu tượng xóa câu hỏi
                    const deleteIcon = document.createElement('i');
                    deleteIcon.classList.add('fas', 'fa-trash-alt'); // Icon xóa
                    deleteIcon.title = 'Delete Question'; // Tooltip
                    deleteIcon.style.cursor = 'pointer';
                    deleteIcon.style.color = 'red';
                    deleteIcon.addEventListener('click', () => {
                        if (confirm(`Are you sure you want to delete this question: "${q.question}"?`)) {
                            deleteQuestion(q._id);
                        }
                    });

                    // Thêm các biểu tượng vào container
                    actionsDiv.appendChild(editIcon);
                    actionsDiv.appendChild(deleteIcon);

                    // Thêm container biểu tượng vào danh sách
                    li.appendChild(actionsDiv);
                    questionsList.appendChild(li);
                });
            } else {
                questionsList.innerHTML = '<p>No questions found for this exam.</p>';
            }
        }

        const viewQuestionsForm = document.getElementById('view-questions-form');
        const examSelectView = document.getElementById('exam-select-view');

        // Populate exam dropdown for viewing questions
        async function populateExamDropdown() {
            const response = await fetch(`${API_BASE}/exams`);
            const exams = await response.json();

            examSelectView.innerHTML = '<option value="">Select an exam</option>'; // Thêm tùy chọn mặc định
            exams.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.id;
                option.textContent = exam.title;
                examSelectView.appendChild(option);
            });
        }

        viewQuestionsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const examId = examSelectView.value;

            if (!examId) {
                alert('Please select an exam to view questions.');
                return;
            }

            // Chuyển hướng đến viewQuestions.html với examId trong query string
            window.location.href = `viewQuestions.html?examId=${examId}`;
        });

        populateExamDropdown();
        fetchQuestions();
    </script>
</body>
</html>
